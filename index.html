<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ig0 prox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        /* Monochrome/Grayscale Aesthetic */
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Very light gray */
            color: #333;
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Tab Bar Styling */
        #tabBar {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 8px;
            border-bottom: 2px solid #ddd;
        }
        .tab-button {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-right: 4px;
            background-color: #e5e7eb;
            color: #333;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.15s;
        }
        .tab-button:hover {
            background-color: #d1d5db;
        }
        .tab-close {
            margin-left: 8px;
            font-weight: bold;
            color: #777;
        }
        .tab-close:hover {
            color: #000;
        }
        /* Custom glow effect for button (monochrome glow) */
        .btn-glow { transition: all 0.3s ease; }
        .btn-glow:hover { box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.5); }
        .btn-neutral { background-color: #333; color: white; border: 1px solid #333; }
        .btn-neutral:hover { background-color: #555; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Main Application UI -->
    <div id="main-ui" class="fade-in max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-neutral-900 tracking-tight">ig0 prox</h1>
            <!-- Description removed as requested -->
        </header>

        <main class="bg-white p-6 md:p-8 rounded-xl shadow-xl space-y-6">
            <div class="space-y-4">
                <label for="urlInput" class="block text-lg font-semibold text-neutral-800">Enter Target URL:</label>
                <input type="url" id="urlInput" placeholder="e.g., https://www.google.com" required
                       class="w-full p-4 border border-neutral-300 rounded-lg focus:ring-neutral-500 focus:border-neutral-500 text-neutral-800 transition duration-150 ease-in-out"
                       onkeydown="if(event.key === 'Enter') launchNewTab()">
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row gap-4">
                <button onclick="launchNewTab()" id="proxyButton"
                        class="flex-1 p-4 font-bold rounded-lg shadow-lg focus:outline-none focus:ring-4 focus:ring-neutral-500 focus:ring-opacity-50 btn-glow transition duration-150 btn-neutral">
                    Go! (Launch in Blank Window)
                </button>
                <button onclick="clearAllTabs()" id="clearButton"
                        class="p-4 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-400 focus:ring-opacity-50 transition duration-150">
                    Close All Tabs
                </button>
            </div>
            
            <div id="messageBox" class="text-red-600 font-medium text-center hidden p-2 bg-red-100 border border-red-300 rounded-lg"></div>

            <div id="loadingIndicator" class="hidden text-center">
                <svg class="animate-spin h-5 w-5 mr-3 text-neutral-600 inline" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Launching tab...
            </div>
        </main>
    </div>
    
    <!-- Tab Bar Container -->
    <div class="max-w-4xl mx-auto mt-6">
        <h2 class="text-lg font-semibold text-neutral-800 mb-2">Active Tabs:</h2>
        <div id="tabBar" class="border-neutral-300">
            <!-- Tab buttons will be injected here -->
        </div>
    </div>


    <script>
        const urlInput = document.getElementById('urlInput');
        const messageBox = document.getElementById('messageBox');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tabBar = document.getElementById('tabBar');
        
        // Tab state: Array of { id: string, name: string, windowRef: Window }
        let activeTabs = [];

        // --- WORKER DEPLOYMENT CHANGE START ---
        const proxyBaseUrl = 'https://time.alansanti2248.workers.dev'; 
        // --- WORKER DEPLOYMENT CHANGE END ---

        // Function to show error messages
        function showMessage(msg, isError = true) {
            messageBox.textContent = msg;
            messageBox.className = isError 
                ? 'text-red-600 font-medium text-center p-2 bg-red-100 border border-red-300 rounded-lg'
                : 'text-green-600 font-medium text-center p-2 bg-green-100 border border-green-300 rounded-lg';
            messageBox.classList.remove('hidden');
        }

        // Function to normalize the URL
        function normalizeUrl(url) {
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            return url;
        }

        // Renders the tab buttons based on the activeTabs array
        function renderTabs() {
            tabBar.innerHTML = '';
            if (activeTabs.length === 0) {
                 tabBar.innerHTML = '<p class="text-neutral-500 p-2">No active tabs.</p>';
                 return;
            }

            activeTabs.forEach(tab => {
                const tabButton = document.createElement('div');
                tabButton.className = 'tab-button';
                tabButton.onclick = () => switchTab(tab.id);
                tabButton.innerHTML = `
                    <span>${tab.name}</span>
                    <span class="tab-close" onclick="event.stopPropagation(); closeTab('${tab.id}')">X</span>
                `;
                tabBar.appendChild(tabButton);
            });
        }
        
        // Brings a specific proxied window to the foreground
        function switchTab(id) {
            const tab = activeTabs.find(t => t.id === id);
            if (tab && tab.windowRef && !tab.windowRef.closed) {
                tab.windowRef.focus();
                showMessage(`Switched to tab: ${tab.name}`, false);
            } else if (tab) {
                // If the user manually closed the window, clean up the tab button
                closeTab(id);
                showMessage(`Tab ${tab.name} was already closed and has been removed.`, true);
            }
        }

        // Removes a tab from the array and closes its window
        function closeTab(id) {
            const index = activeTabs.findIndex(t => t.id === id);
            if (index > -1) {
                const tabToClose = activeTabs[index];
                if (tabToClose.windowRef && !tabToClose.windowRef.closed) {
                    tabToClose.windowRef.close();
                }
                activeTabs.splice(index, 1);
                renderTabs();
                showMessage(`Tab "${tabToClose.name}" closed.`, false);
            }
        }
        
        // Closes all tabs and their corresponding windows
        function clearAllTabs() {
            activeTabs.forEach(tab => {
                if (tab.windowRef && !tab.windowRef.closed) {
                    tab.windowRef.close();
                }
            });
            activeTabs = [];
            renderTabs();
            showMessage("All tabs closed.", false);
        }


        // The core function: Opens in a clean, separate window and creates a new tab entry
        function launchNewTab() {
            messageBox.classList.add('hidden');
            let url = urlInput.value.trim();

            if (!url) {
                showMessage("Please enter a URL to launch.", true);
                return;
            }
            
            if (proxyBaseUrl.includes('YOUR-WORKER-NAME')) {
                 showMessage("Error: The Worker URL is still a placeholder. Please replace 'https://YOUR-WORKER-NAME.workers.dev' in the JavaScript with your actual deployed Worker URL.", true);
                 return;
            }

            url = normalizeUrl(url);
            const proxyUrl = `${proxyBaseUrl}/?target=${encodeURIComponent(url)}`;
            
            loadingIndicator.classList.remove('hidden');

            const tabId = crypto.randomUUID();
            const tabName = new URL(url).hostname;
            
            // Open the new window immediately
            const newWindow = window.open('about:blank', tabId);
            
            if (newWindow) {
                // Add the new tab to the state immediately
                activeTabs.push({ id: tabId, name: tabName, windowRef: newWindow });
                renderTabs();

                // Inject the proxy content into the new window
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html style="margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%;">
                    <head><title>Loading ${tabName}...</title></head>
                    <body style="margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%;">
                        <!-- iframe is now only inside the new, isolated window -->
                        <iframe src="${proxyUrl}" style="width: 100%; height: 100%; border: none; margin: 0; padding: 0;"></iframe>
                    </body>
                    </html>
                `);
                newWindow.document.close();
                
                // Set a recurring check to clean up tabs if the window is closed manually
                const cleanupInterval = setInterval(() => {
                    if (newWindow.closed) {
                        clearInterval(cleanupInterval);
                        closeTab(tabId);
                    }
                }, 1000);

                showMessage(`Successfully launched new tab for: ${tabName}`, false);
            } else {
                showMessage("Could not open new window. Check your browser's pop-up blocker.", true);
            }
            
            loadingIndicator.classList.add('hidden');
            urlInput.value = '';
        }
        
        // Initial render on load
        window.onload = renderTabs;
    </script>
</body>
</html>
